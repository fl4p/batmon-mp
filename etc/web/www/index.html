<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>

    <script type="text/javascript" src="util.js"></script>
    <script type="text/javascript" src="https://unpkg.com/dygraphs@2.2.1/dist/dygraph.min.js"></script>
    <script type="text/javascript" src="synchronizer.js"></script>

    <script type='module'>
        import {struct} from './struct.mjs'
        import {crc16modbus} from './crc.mjs'

        window.struct = struct;
        window.crc16modbus = crc16modbus;
    </script>

    <link rel="stylesheet" type="text/css" href="https://unpkg.com/dygraphs@2.2.1/dist/dygraph.min.css"/>
    <style>
        body {
            background: #111;
            color: #fff;
        }


        .plot-view {
            width: 100%;
            margin-bottom: 2.2em;
        }


        /* Legend */
        .dygraph-legend > span {
            color: #fff;
        }

        /* Title: */
        .dygraph-label, .dygraph-title {
            color: #fff;
        }

        /* x-axis label: */
        .dygraph-label, .dygraph-xlabel {
            color: #fff;
        }

        /* y-axis label: */
        .dygraph-label, .dygraph-ylabel {
            color: #fff;
        }

        /* y2-axis label: */
        .dygraph-label, .dygraph-y2label {
            color: #fff;
        }

        /* x-axis label: */
        .dygraph-axis-label, .dygraph-axis-label-x {
            color: #fff;
        }

        /* y-axis label: */
        .dygraph-axis-label, .dygraph-axis-label-y {
            color: #fff;
        }

        /* y2-axis label */
        .dygraph-axis-label, .dygraph-axis-label-y, .dygraph-axis-label-y2 {
            color: #fff;
        }
    </style>
</head>
<body>
<h1>Hello</h1>

<button onclick="connect()">Connect</button>
<button onclick="updateFileView()">Refresh File List</button>

<span id="progressView"></span>

<pre id="fileView"></pre>

<div id="plotView"></div>

<script>
    function msg(m) {
        console.log(m);
    }

    async function connect() {
        //const device1 = await navigator.bluetooth.getDevices();
        const device = await navigator.bluetooth.requestDevice({
            filters: [{services: [0x5798]}]
        });

        function onDisconnected(event) {
            msg('Device ' + device.name + ' is disconnected.');
            _sendCommandResolve = null;
            _sendCommandReject = null;
            fileView.innerHTML = '';

        }

        device.addEventListener('gattserverdisconnected', onDisconnected);

        const server = await device.gatt.connect();

        msg('connected', device.name);

        const service = await server.getPrimaryService(0x5798);

        ioChar = await service.getCharacteristic(0xe8d7);
        await ioChar.startNotifications();
        ioChar.addEventListener('characteristicvaluechanged', onTransferStatusChanged);


        await updateFileView();
    }

    async function updateFileView() {
        fileView.style.opacity = .5;
        const resp = await sendCommand("list");
        //console.log("list resp", new TextDecoder().decode(resp));
        fileView.innerHTML = (new TextDecoder().decode(resp)).split('\n')
            .map(f => `<a href="#" onclick="viewFile('${f}')">${f}</a>`).join('\n');
        fileView.style.opacity = 1;
    }

    var _expectedSize = 0;

    async function viewFile(file) {
        const [siz, fn] = file.split(':');
        _expectedSize = +siz;
        const t0 = Date.now();
        const data = await sendCommand("read " + fn);
        console.log('viewFile received', data.length, 'expected', +siz,
            Math.round(data.byteLength / (Date.now() - t0)), 'kb/s');
        await plotFile(fn, data);
        // tamp inflate, varint, zigzag, delta decode
    }

    async function dlFile(url) {
        const resp = await fetch(url);
        return [await resp.bytes(), new Date(resp.headers.get('Last-Modified'))];
    }

    function readRows(bytes, head, fmt) {
        s = window.struct(fmt);
        const rowSize = s.size;
        const numRows = (bytes.length / rowSize) | 0;
        //const columnData = Array(head.length).fill().map(() => Array(numRows).fill());
        const columnData = Array(head.length).fill().map(() => Array(numRows).fill());
        console.log(head, numRows, 'rows', rowSize, 'bytes/row')
        console.assert(bytes.length % rowSize === 0);
        const converters = {
            time: x => (x * 10) * 1000,
            voltage: x => x / 100,
            current: x => x / 100,
            soc2: x => x / 2,
            temp2: x => x / 2 - 40,
        }

        let t = 0, tOff = 0, prevRow = null;
        for (let i = 0; i < numRows; i++) {
            const row = s.unpack_from(bytes.buffer, i * rowSize);
            //  //const fn = 'JKPferdestall-time,voltage,current,temp2,soc2,cell_min,cell_max,minmax_idx-HHhBBHHB.bin';
            // make overflowing time values monontonic
            if (row[0] + tOff < t)
                tOff = t - row[0] + 1
            row[0] += tOff;
            t = row[0];

            if (prevRow && row[4] === 0) {
                //console.log('skip', head, row);
                //continue;
                row[3] = prevRow[3]; // temp
                row[4] = prevRow[4]; // soc
            }

            for (let j = 0; j < head.length; j++) {
                const conv = converters[head[j]];
                let y = row[j];
                if (conv) y = conv(y);
                columnData[j][i] = y;
            }
            prevRow = row;
        }

        return columnData;
    }

    const toHex = (value) => {
        return value.map(v => v.toString(16).padStart(2, '0')).join(' ');
    }

    function lowPass(x, len) {
        console.assert(len % 2 === 0);
        y = new Array(x.length);
        for (let i = 0; i < x.length; i++) {
            let s = 0;
            for (let j = -len / 2; j < len / 2; j++) {
                s += x[Math.max(0, Math.min(i + j, x.length - 1))];
            }
            y[i] = s / len;
        }
        return y;
    }

    /**
     * @param {string} fn
     * @param {Uint8Array<ArrayBufferLike>} bytes
     */
    async function plotFile(fn, bytes, lastModified) {
        window.currentPlotFile = [fn, bytes, lastModified];
        //const fn = 'JKPferdestall-time,voltage,current,temp2,soc2,cell_min,cell_max,minmax_idx-HHhBBHHB.bin';
        const ext = fn.substring(fn.lastIndexOf('.'));
        let [name, head, fmt] = fn.substring(0, fn.length - ext.length).split('-');
        head = head.split(',')

        const columnData = readRows(bytes, head, fmt);

        console.log(columnData);

        const timeColumn = columnData[0];
        const tOff = new Date(lastModified) - timeColumn[timeColumn.length - 1];

        document.getElementById("plotView").innerHTML = head
            .map(h => `<div><div class="plot-view" id="plot-${h}"></div></div>`).join('');

        const gs = [];
        for (let i = 1; i < columnData.length; i++) {
            const dyData = lowPass(columnData[i], 8).map((y, j) => [new Date(timeColumn[j] + tOff), y]);
            //const dyData = (columnData[i]).map((y, j) => [new Date(timeColumn[j] + tOff), y]);
            //console.log(head[i], 'dyData', dyData);
            const el = document.getElementById("plot-" + head[i]);
            gs.push(new Dygraph(
                el,
                dyData,
                {
                    //customBars: true,
                    width: el.getBoundingClientRect().width - 25,
                    height: 360,
                    color: 'hsla(205, 71%, 49%, 1)',
                    title: head[i], // + ' ' + fmt[i],
                    ylabel: head[i],
                    //legend: 'always',
                    showRangeSelector: true,
                    drawPoints: true,
                    //valueRange: [null, null],
                }
            ));
            /*
                            if row[0] + t_off < t:
                    t_off = t - row[0] + 1
                row[0] += t_off
                t = row[0]
             */
        }

        var sync = Dygraph.synchronize(gs);

        update = function update() {
            var zoom = 1 || document.getElementById('chk-zoom').checked,
                selection = 1 || document.getElementById('chk-selection').checked,
                syncRange = 1 || document.getElementById('chk-range').checked;
            //document.getElementById('chk-range').disabled = !zoom;

            sync.detach();
            sync = Dygraph.synchronize(gs, {
                zoom: false,
                selection: 1,
                range: false,
            });
        }


    }

    var _sendCommandResolve = null, _sendCommandReject = null;
    var _commandTimeout = null;

    function sendCommand(cmd, noResponse = false) {
        if (_sendCommandResolve != null)
            throw new Error('command in progress');

        recvBuf.length = 0;
        ioChar.writeValue(new TextEncoder().encode(cmd));
        console.log('sent', cmd)

        if (!noResponse) {
            _sendCommandPromise = new Promise((resolve, reject) => {
                _sendCommandResolve = resolve;
                _sendCommandReject = reject;
                _commandTimeout = setTimeout(() => reject(new Error('timeout')), 2000);
            });
            return _sendCommandPromise;
        }
        return null;
    }


    recvBuf = []


    function onTransferStatusChanged(event) {
        /** @type DataView */
        const val = event.target.value;

        //console.log('rx', "'" + (new TextDecoder().decode(val)) + "'");
        //console.log('rx', val.byteLength, toHex([...new Uint8Array(val.buffer)]));

        function rst() {
            _sendCommandResolve = null;
            _sendCommandReject = null;
            if (_commandTimeout) clearTimeout(_commandTimeout);
            _commandTimeout = null;
            _expectedSize = 0;
            progressView.innerHTML = '';
        }

        if (_sendCommandResolve) {
            if (_expectedSize) {
                const progress = Math.round(recvBuf.reduce((a, b) => a + b.byteLength, 0) / _expectedSize * 1000) / 10;
                progressView.innerHTML = progress.toFixed(1) + ' %';
                //console.log('progress', progress.toFixed(1));
            }
            if (_commandTimeout !== null) {
                clearTimeout(_commandTimeout);
                _commandTimeout = setTimeout(() => {
                    _sendCommandReject(new Error('timeout'));
                    rst();
                }, 8000);
            }
            if (val.byteLength === 1 && val.getInt8(0) === '\n'.charCodeAt(0)) {
                const data = concatData(recvBuf);
                recvBuf.length = 0;
                const crc = crc16modbus(data);
                console.log("command response", 'crc', crc, "'" + (new TextDecoder().decode(data)) + "'");
                if (_expectedSize && _expectedSize != data.byteLength) {
                    _sendCommandReject(new Error('rx size != expected size'));
                } else {
                    _sendCommandResolve(data);
                }
                rst();
            } else {
                recvBuf.push(val);
            }
        }
    }

    document.addEventListener('DOMContentLoaded',
        (async () => {
            const fn = 'JKPferdestall-time,voltage,current,temp2,soc2,cell_min,cell_max,minmax_idx-HHhBBHHB.bin';
            await plotFile(fn, ...await dlFile(fn));
        }));


    function savePlotFile() {
        if(!window.currentPlotFile) return;
        const [filename, data, lastMod] = window.currentPlotFile;
        const blob = new Blob([data], {type: 'application/octet-stream'});
        if (window.navigator.msSaveOrOpenBlob) {
            window.navigator.msSaveBlob(blob, filename);
        } else {
            const elem = window.document.createElement('a');
            elem.href = window.URL.createObjectURL(blob);
            elem.download = filename;
            document.body.appendChild(elem);
            elem.click();
            document.body.removeChild(elem);
        }
    }

</script>

<button onclick="savePlotFile()">Download</button>

</body>
</html>